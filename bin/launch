#!/usr/bin/env bash
# Launch multiple Claude CLI sessions in tmux
# Usage: launch [options] "task1" "task2" "task3"
#        launch -f tasks.txt

set -euo pipefail

SESSION_NAME="claudes"
USE_WORKTREES=false
WORK_DIR="$HOME/.claudes-work"
TASKS=()

show_help() {
  cat <<EOF
Usage: $(basename "$0") [options] "task1" "task2" ...
       $(basename "$0") -f tasks.txt

Launch N Claude CLI sessions in tmux, one per task.

Options:
  -f FILE         Read tasks from file (double-blank-line delimited)
  -n NAME         Session name (default: claudes)
  -w              Use git worktrees (isolate changes per task)
  -d DIR          Work directory for worktrees (default: ~/.claudes-work)
  -h              Show this help

Task Input:
  - Command line args: each argument is a task
  - File (-f): tasks separated by TWO+ blank lines (allows multiline with single blanks)
  - Stdin (-f -): tasks separated by TWO+ blank lines

Examples:
  launch "Review auth.py" "Run tests" "Fix bug #123"
  launch -f tasks.txt -w
  echo "Review all .go files" | launch -f -
  pbpaste | launch -f -
EOF
  exit 0
}

while getopts "f:n:wd:h" opt; do
  case $opt in
    f) TASK_FILE="$OPTARG" ;;
    n) SESSION_NAME="$OPTARG" ;;
    w) USE_WORKTREES=true ;;
    d) WORK_DIR="$OPTARG" ;;
    h) show_help ;;
    *) show_help ;;
  esac
done
shift $((OPTIND - 1))

# Load tasks from file or args
if [ -n "${TASK_FILE:-}" ]; then
  # Read entire input
  if [ "$TASK_FILE" = "-" ]; then
    INPUT=$(cat)
  else
    INPUT=$(cat "$TASK_FILE")
  fi

  # Split by double-newlines (two+ blank lines) using awk
  # This allows single blank lines within a task
  # Output null-delimited for safe parsing (handles multiline tasks)
  mapfile -d '' -t TASKS < <(echo "$INPUT" | awk 'BEGIN{RS="\n\n\n+"} NF{printf "%s%c", $0, 0}')

  # Filter out any empty tasks
  FILTERED=()
  for task in "${TASKS[@]}"; do
    # Trim leading/trailing whitespace and check if non-empty
    trimmed=$(echo "$task" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
    if [ -n "$trimmed" ]; then
      FILTERED+=("$trimmed")
    fi
  done
  TASKS=("${FILTERED[@]}")
else
  TASKS=("$@")
fi

[ ${#TASKS[@]} -eq 0 ] && { echo "Error: No tasks specified" >&2; show_help; }

# Check dependencies
command -v tmux >/dev/null || { echo "Error: tmux required" >&2; exit 1; }
command -v claude >/dev/null || { echo "Error: claude required" >&2; exit 1; }

# Check for existing session
tmux has-session -t "$SESSION_NAME" 2>/dev/null && {
  echo "Session '$SESSION_NAME' already exists"
  echo "Attach: tmux attach -t $SESSION_NAME"
  echo "Kill:   tmux kill-session -t $SESSION_NAME"
  exit 1
}

# Setup worktrees if requested
if [ "$USE_WORKTREES" = true ]; then
  git rev-parse --git-dir >/dev/null 2>&1 || {
    echo "Error: -w requires git repository" >&2
    exit 1
  }
  BRANCH=$(git rev-parse --abbrev-ref HEAD)
  mkdir -p "$WORK_DIR"
  echo "Setting up ${#TASKS[@]} worktrees..."
  for i in "${!TASKS[@]}"; do
    WDIR="$WORK_DIR/task-$i"
    [ -d "$WDIR" ] || git worktree add -q "$WDIR" "$BRANCH" 2>/dev/null || true
  done
fi

echo "Creating session with ${#TASKS[@]} tasks..."

# Create session
tmux new-session -d -s "$SESSION_NAME" -n "tasks"

# Create panes (first one already exists)
for ((i=1; i<${#TASKS[@]}; i++)); do
  tmux split-window -t "$SESSION_NAME:0"
done

# Layout panes
tmux select-layout -t "$SESSION_NAME:0" tiled

# Create temp directory for task files
TASK_DIR=$(mktemp -d -t claudes-tasks-XXXXXX)

# Write each task to a temp file (handles multiline, special chars)
for i in "${!TASKS[@]}"; do
  printf '%s' "${TASKS[$i]}" > "$TASK_DIR/task-$i"
done

# Start tasks in each pane
for i in "${!TASKS[@]}"; do
  PANE="$SESSION_NAME:0.$i"

  if [ "$USE_WORKTREES" = true ]; then
    WDIR="$WORK_DIR/task-$i"
    tmux send-keys -t "$PANE" "cd '$WDIR'" C-m
  fi

  # Pipe task from file to claude (handles multiline and special characters)
  tmux send-keys -t "$PANE" "claude < '$TASK_DIR/task-$i'" C-m
done

echo "âœ“ Session '$SESSION_NAME' created"
echo ""
echo "Tasks:"
for i in "${!TASKS[@]}"; do
  echo "  [$i] ${TASKS[$i]}"
done
echo ""

sleep 1

# Set active session - use switch-client if already in tmux, attach otherwise
if [ -n "${TMUX:-}" ]; then
  echo "Switching to session (Ctrl-b d to detach)..."
  exec tmux switch-client -t "$SESSION_NAME"
else
  echo "Attaching to session (Ctrl-b d to detach)..."
  exec tmux attach -t "$SESSION_NAME"
fi
